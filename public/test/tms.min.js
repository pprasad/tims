/*
 *@Auth Prasad
 *@File Name tms.min.js
 *@TestFile  
 */
var TIMS={};
var tims=TIMS||{};
var dataTable=null;
var request={};
var requestData=null;
var treeroot_nodes=[];
var resultDataset=null;
var golbalData=null;
var STATUS_TYPE={
   passed:2,
   failed:3,
   blocked:4,
   pending:5,
   dropped:6,
   passedexp:8
};
var id=0,index=0;
tims.Floders=function(fldTitle){
    var Response={};var subFldr=new Array();
    Response.FldrTitle=fldTitle;
    var url='/timsdatasearch/'+fldTitle;
	//var url='/json';
	var response=tims.getResonse(url);
	response.done(function(msg){
	   if(msg!=''){ 
		   request.acno=msg[0].AccountName;
		   request.gid=msg[0].Workspace.GID
		   request.path=msg[0].EntityPath;
		   url='/timsgroupby';
		   response=tims.getGroup(url,request);
		   response.done(function(msg){
			  console.info(msg);
			  msg=$(msg).sort(tims.Sort);
			  console.info("Sorted{}"+JSON.stringify(msg));
			  tims.preparedStructure(msg);
			  golbalData=msg;
		   });
	    }else{
		 $('#dataGrid tbody tr').remove();
		 $('#dataGrid tbody ').append("<tr><td colspan='4' style='text-align:center'>"+ERROR_MESSAGE.NO_SUCH_DATA+"<td></tr>");
	    }	
   });
  /*response=tims.getGroup(url,request);
    response.done(function(msg){
			  console.info(msg);
			  msg=$(msg).sort(tims.Sort);
			  alert(JSON.stringify(msg));
			  tims.preparedStructure(msg);
    });*/
 };
tims.Sort=function(a,b){
  return a.me_id>b.me_id ? 1 : -1;
} 
tims.getResonse=function(url){
    
   var response=$.ajax({
         url:url,
		 type:'GET',
		 async:false
	});
   return response;
}
tims.getGroup=function(url,request){
  var response=$.ajax({
                 url:url,
				 type:'GET',
                 data:request,
                 async:false  				 
            });  
   return response;			
}
tims.formatData=function(subTable){
   console.info("SubTable{}"+JSON.stringify(subTable));
   index=index+1;
   var table='<table  id="table_'+index+'"  border="0" >';
   for(row  in subTable.child){
      id=id+1; 
      console.info("Row Data{}"+subTable.child[row].val);
      table+='<tr><td id="row_'+id+'" class="downArrow" role="row" style="text-align:right;width:17%" onclick="tims.tableEvent(this);">'+subTable.child[row].val+'</td>';
	  table +='<td>'+subTable.child[row].passed+'</td>';
	  table +='<td>'+subTable.child[row].pending+'</td>';
	  table +='<td>'+subTable.child[row].failed+'</td>';
	  table +='<td>'+subTable.child[row].passedexp+'</td>';
	  table+='</tr>';
	  
	}
	
  return table;
}  
tims.search=function(val,object){
  var table=null;
  $(object).each(function(key,obj){
         alert(obj.val);
        if(obj.val==val){
		     table=tims.formatData(obj);
		}
		else{
		   table=tims.search(val,obj.child);
		}
   });
   return table;
}
//var data='[{"FldrTitle":"MongoFolder1","Status":null,"Title":"MongoFolder2","Type":1,"count":1},{"FldrTitle":"MongoFolder1","Status":null,"Title":"MongoFolder3","Type":1,"count":1},{"FldrTitle":"MongoFolder3","Status":null,"Title":"MongoFolder4","Type":1,"count":1},{"FldrTitle":"MongoFolder4","Status":null,"Title":"MongoFolder5","Type":1,"count":1},{"FldrTitle":"MongoFolder2","Status":5,"Title":"Result1","Type":102,"count":1},{"FldrTitle":"MongoFolder4","Status":3,"Title":"Result10","Type":102,"count":1},{"FldrTitle":"MongoFolder4","Status":6,"Title":"Result11","Type":102,"count":1},{"FldrTitle":"MongoFolder4","Status":6,"Title":"Result12","Type":102,"count":1},{"FldrTitle":"MongoFolder5","Status":4,"Title":"Result13","Type":102,"count":1},{"FldrTitle":"MongoFolder5","Status":4,"Title":"Result14","Type":102,"count":1},{"FldrTitle":"MongoFolder5","Status":2,"Title":"Result15","Type":102,"count":1},{"FldrTitle":"MongoFolder5","Status":2,"Title":"Result16","Type":102,"count":1},{"FldrTitle":"MongoFolder5","Status":8,"Title":"Result17","Type":102,"count":1},{"FldrTitle":"MongoFolder5","Status":8,"Title":"Result18","Type":102,"count":1},{"FldrTitle":"MongoFolder2","Status":2,"Title":"Result2","Type":102,"count":1},{"FldrTitle":"MongoFolder2","Status":3,"Title":"Result3","Type":102,"count":1},{"FldrTitle":"MongoFolder2","Status":2,"Title":"Result4","Type":102,"count":1},{"FldrTitle":"MongoFolder2","Status":8,"Title":"Result5","Type":102,"count":1},{"FldrTitle":"MongoFolder2","Status":2,"Title":"Result6","Type":102,"count":1},{"FldrTitle":"MongoFolder4","Status":2,"Title":"Result7","Type":102,"count":1},{"FldrTitle":"MongoFolder4","Status":2,"Title":"Result8","Type":102,"count":1},{"FldrTitle":"MongoFolder4","Status":3,"Title":"Result9","Type":102,"count":1}]';
var data='[{"FldrTitle":"MongoFolder1","Status":null,"Title":"MongoFolder2","Type":1,"me_id":835,"Defects":null,"count":1},{"FldrTitle":"MongoFolder1","Status":null,"Title":"MongoFolder3","Type":1,"me_id":836,"Defects":null,"count":1},{"FldrTitle":"MongoFolder3","Status":null,"Title":"MongoFolder4","Type":1,"me_id":837,"Defects":null,"count":1},{"FldrTitle":"MongoFolder2","Status":5,"Title":"Result1","Type":102,"me_id":838,"Defects":null,"count":1},{"FldrTitle":"MongoFolder2","Status":2,"Title":"Result2","Type":102,"me_id":839,"Defects":null,"count":1},{"FldrTitle":"MongoFolder2","Status":3,"Title":"Result3","Type":102,"me_id":841,"Defects":["CSCuh51323","CSCui14362"],"count":1},{"FldrTitle":"MongoFolder2","Status":2,"Title":"Result4","Type":102,"me_id":842,"Defects":null,"count":1},{"FldrTitle":"MongoFolder2","Status":8,"Title":"Result5","Type":102,"me_id":843,"Defects":null,"count":1},{"FldrTitle":"MongoFolder2","Status":2,"Title":"Result6","Type":102,"me_id":844,"Defects":null,"count":1},{"FldrTitle":"MongoFolder4","Status":2,"Title":"Result7","Type":102,"me_id":851,"Defects":null,"count":1},{"FldrTitle":"MongoFolder4","Status":2,"Title":"Result8","Type":102,"me_id":852,"Defects":null,"count":1},{"FldrTitle":"MongoFolder4","Status":3,"Title":"Result9","Type":102,"me_id":853,"Defects":["CSCui68082"],"count":1},{"FldrTitle":"MongoFolder4","Status":3,"Title":"Result10","Type":102,"me_id":854,"Defects":["CSCui81388","CSCug68855"],"count":1},{"FldrTitle":"MongoFolder4","Status":6,"Title":"Result11","Type":102,"me_id":855,"Defects":null,"count":1},{"FldrTitle":"MongoFolder4","Status":6,"Title":"Result12","Type":102,"me_id":856,"Defects":null,"count":1},{"FldrTitle":"MongoFolder4","Status":null,"Title":"MongoFolder5","Type":1,"me_id":857,"Defects":null,"count":1},{"FldrTitle":"MongoFolder5","Status":4,"Title":"Result13","Type":102,"me_id":858,"Defects":null,"count":1},{"FldrTitle":"MongoFolder5","Status":4,"Title":"Result14","Type":102,"me_id":859,"Defects":null,"count":1},{"FldrTitle":"MongoFolder5","Status":2,"Title":"Result15","Type":102,"me_id":860,"Defects":null,"count":1},{"FldrTitle":"MongoFolder5","Status":2,"Title":"Result16","Type":102,"me_id":861,"Defects":null,"count":1},{"FldrTitle":"MongoFolder5","Status":8,"Title":"Result17","Type":102,"me_id":862,"Defects":null,"count":1},{"FldrTitle":"MongoFolder5","Status":8,"Title":"Result18","Type":102,"me_id":863,"Defects":null,"count":1}]';
tims.preparedStructure=function(response){
    var HashStack={}; 
    data=eval(data);
	golbalData=data;
    var Request={};
	var node={val:null,parent:null,ref:{},child:[],passed:0,failed:0,blocked:0,pending:0,dropped:0,passedexp:0};
	var rootNode=node;
	var b=b||{};
	var parent={};
	b.add=function(node,obj,obj1){
	    var childnode={};
		//debugger;
	    if(node.val==null && obj.Type==1){
		      node.val=obj.FldrTitle;
			  node.parent=null;
			  b.findStatus(node,obj1);
			  childnode.val=obj.Title;
			  childnode.parent=obj.FldrTitle;
			  childnode.child=[];
			  //debugger;
			  b.findStatus(childnode,obj1);
			  node.child.push(childnode);
		}
		else{
		    console.info("FldrTitle{}"+node.val);
		    if(node.val==obj.FldrTitle  && obj.Type==1){
			   childnode.val=obj.Title;
			   childnode.parent=obj.FldrTitle;
			   childnode.child=[];
			   b.findStatus(childnode,obj1);
			   node.child.push(childnode);
			}
			else{
			   //rootNode=node;
			   b.addChild(node,obj,obj1);
			}
		}
	}
	b.addChild=function(node,obj,obj1){
	    var childnode={};
		   console.info("ChildernInformation{}"+obj.FldrTitle+" ParentNode{}"+node.val);
		   $(node.child).each(function(key,val){
		        console.info("FolderInformation{}"+obj.FldrTitle+" Value infomation{}"+val.val);
				if(val.val==obj.FldrTitle && obj.Type==1){
					 childnode.val=obj.Title;
					 childnode.parent=obj.FldrTitle;
					 childnode.child=[];
					 b.findStatus(childnode,obj1);
					 val.child.push(childnode);
				}
				else{
				   console.info("Childern Data{}"+val.val);
				   if(val.child.length!=0){
						console.info("Length{}"+val.child.length+"  Childern Parent{}"+val.val+"  Childern Parent childern{}"+val.child[0]);
						$(val.child).each(function(k,v){
						    //console.info("Key"+k+"  value"+v);
							 $(v).each(function(k1,v1){
							     console.info("Key"+k1+"  value"+v1);
							 });
						});
						//parent=node.child;
						b.addChild(val,obj,obj1);
				   }
			    }
		   }); 
	
	}
	b.escape = function (str) {
	  //return str.replace(//g, '') b.findParent(val,rootNode);
   	};
	b.findStatus=function(childnode,obj){
	   var parentNode=null;
	   childnode.passed=0;childnode.failed=0;
	   childnode.blocked=0;childnode.pending=0;
	   childnode.dropped=0;childnode.passedexp=0;
	   console.info("Before Childer"+childnode.val);
	   //debugger;
	   $(obj).each(function(key,value){
	       if(value.FldrTitle==childnode.val){
		        if(STATUS_TYPE.passed==value.Status){
                     childnode.passed=childnode.passed+1;
			    }else if(STATUS_TYPE.failed==value.Status){
                     childnode.failed=childnode.failed+1;
				}else if(STATUS_TYPE.blocked==value.Status){
                     childnode.blocked=childnode.blocked+1;
		    	}else if(STATUS_TYPE.pending==value.Status){
                     childnode.pending=childnode.pending+1;
			    }else if(STATUS_TYPE.dropped==value.Status){
                     childnode.dropped=childnode.dropped+1;
			    }else if(STATUS_TYPE.passedexp==value.Status){
                     childnode.passedexp=childnode.passedexp+1;
				}				
		   }
	   })
	 
	}
	//Find Lasmost Node
	b.findLastNode=function(node){
	   $(node).each(function(key,valObj){
	         if(valObj.child==0){
			      b.findParent(valObj,rootNode);
			 }
			 else{
			   b.findLastNode(valObj.child);
			 }
	    });
	}
	//Calculating Parent
	b.findParent=function(childnode,node){
	    //debugger; 
        console.info("Find Parent Info{}"+childnode.val+"   Node Information{}"+JSON.stringify(node)); 
		if(!HashStack.hasOwnProperty(childnode.val)){
		     console.info("Enter into Inner Loop....");
		     console.info("BottomToTop{}"+JSON.stringify(childnode));
		     HashStack[childnode.val]=true;
		      b.childCalc(childnode,node);
	    }
				
	}
	
	//Calculating Childern
	b.childCalc=function(childnode,valObj){
	 // alert("Current Dataa"+childnode.val+"Parent Data"+childnode.parent+"  "+JSON.stringify(valObj));
	   $(valObj).each(function(key,valObj1){
               if(valObj1.val==childnode.parent){
				   b.setValues(childnode,valObj1);
				   b.childCalc(valObj1,rootNode);
			    }else{
				   b.childCalc(childnode,valObj1.child);
			   }
       });	   
	}
	b.setValues=function(childnode,valObj){
	     valObj.passed=valObj.passed+childnode.passed;
		 valObj.blocked=valObj.blocked+childnode.blocked;
		 valObj.failed=valObj.failed+childnode.failed;
		 valObj.pending=valObj.pending+childnode.pending;
		 valObj.dropped=valObj.dropped+childnode.dropped;
		 valObj.passedexp=valObj.passedexp+childnode.passedexp;
	}
	for(i=0;i<data.length;i++){
	   b.add(node,data[i],data);
	}
	b.findLastNode(node);
	tims.createRows(node);
	
}
tims.loadTreeView=function(id){
     $("#"+id).treetable({ expandable:true,initialState: "collapsed"});
	 
}
tims.createRows=function(dataGrid){
 //$('#dataGrid tbody tr').remove();
 var parent=dataGrid.val;
 while(treeroot_nodes.length>0){
     var id=treeroot_nodes.pop();
	 $("#dataGrid").treetable("removeNode",id);
 }
 var node=$("#dataGrid").treetable("node",dataGrid.val)
 treeroot_nodes.push(dataGrid.val);
 var row=$("<tr data-tt-id='"+dataGrid.val+"'>");
 row.append("<td><span class='folder'>"+dataGrid.val+"<span></td>");
 row.append("<td><a href=javascript:tims.href_event('"+dataGrid.val+"',"+STATUS_TYPE.passed+")>"+dataGrid.passed+"</a></td><td><a href=javascript:tims.href_event('"+dataGrid.val+"',"+STATUS_TYPE.pending+")>"+dataGrid.pending+"</a></td>");
 row.append("<td><a href=javascript:tims.href_event('"+dataGrid.val+"',"+STATUS_TYPE.failed+")>"+dataGrid.failed+"</a></td><td><a href=javascript:tims.href_event('"+dataGrid.val+"',"+STATUS_TYPE.blocked+")>"+dataGrid.blocked+"</a></td>");
 row.append("<td><a href=javascript:tims.href_event('"+dataGrid.val+"',"+STATUS_TYPE.dropped+")>"+dataGrid.dropped+"</a></td><td><a href=javascript:tims.href_event('"+dataGrid.val+"',"+dataGrid.passedexp+")>"+dataGrid.passedexp+"</a></td>");
 row.append("<td><a href=javascript:tims.href_event('"+dataGrid.val+"',"+STATUS_TYPE.defects+")>"+dataGrid.defects+"</a></td>");
 $("#dataGrid").treetable("loadBranch",node,row);
 for(i=0;i<dataGrid.child.length;i++){
     tims.loadChildRows(parent,dataGrid.child[i],node);
 }
}
tims.loadChildRows=function(parent,object,node){
  console.info("Parent {}"+parent+"  Object"+object);
  $(object).each(function(key,obj){
         row=$("<tr data-tt-id='"+obj.val+"' data-tt-parent-id='"+parent+"'>");
		 row.append("<td><span class='folder'>"+obj.val+"<span></td>");
		 row.append("<td><a href=javascript:tims.href_event('"+obj.val+"',"+STATUS_TYPE.passed+")>"+obj.passed+"</a></td><td><a href=javascript:tims.href_event('"+obj.val+"',"+STATUS_TYPE.pending+")>"+obj.pending+"</a></td>");
		 row.append("<td><a href=javascript:tims.href_event('"+obj.val+"',"+STATUS_TYPE.failed+")>"+obj.failed+"</a></td><td><a href=javascript:tims.href_event('"+obj.val+"',"+STATUS_TYPE.blocked+")>"+obj.blocked+"</a></td>");
		 row.append("<td><a href=javascript:tims.href_event('"+obj.val+"',"+STATUS_TYPE.dropped+")>"+obj.dropped+"</a></td><td><a href=javascript:tims.href_event('"+obj.val+"',"+STATUS_TYPE.passedexp+")>"+obj.passedexp+"</a></td>");
		 row.append("<td><a href=javascript:tims.href_event('"+obj.val+"',"+STATUS_TYPE.defects+")>"+obj.defects+"</a></td>");
		 $("#dataGrid").treetable("loadBranch",node,row);
		 console.info("object.child.length{}"+obj.child+"   Parent"+obj.val);
		 if(obj.child!=undefined){
		     if(obj.child.length!=0){
					parent=obj.val;
					tims.loadChildRows(parent,obj.child);
			 }
		 }
 });
 
}
tims.href_event=function(fldrId,val){
   resultDataset.clear().draw();
   $(golbalData).each(function(key,valObj){
       if(valObj.FldrTitle==fldrId && valObj.Status==val){
	        var result={};
			result.Title=valObj.Title;
			result.Status=valObj.Status;
            resultDataset.rows.add([result]).draw();
		}
   });
   //$.blockUI({'message':$('#resultDialog')});
   $('#resultDialog').dialog({
				autoOpen: true,
				resizable: false,
				width:'500px',my: "center",
					at: "center",
					of: window
	});
}
tims.Close=function(){
   $.unblockUI();
}
tims.resultTable=function(){
   resultDataset=$('#resultDataset').DataTable({
       "paging":false,
       "columns":[
	     { "title":"Result",
		   "data":null,
		   "render":function(data){
		      return data.Title;
		    }
		 },
		 {"title":"Status",
		  "data":null,
		  "render":function(data){
              return data.Status;
           }
		  }		  
		 ]
   });
}		
				 